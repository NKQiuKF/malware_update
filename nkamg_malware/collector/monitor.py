#!/usr/bin/env python
# -*- coding:utf-8 -*-

import datetime
import os
from core import get_sample
from core import get_label
from multiprocessing import Process
from core.settings import deal_with_tmp
from core.settings import TMP_FOLDER
from core.mail import send_email
from core.settings import VT_FILE
from core.settings import SPLIT_TASK_FILE

import ctypes   
libc = ctypes.CDLL('libc.so.6')    
libc.prctl(1,15)

if __name__ == '__main__':
  os.system('mkdir -p '+TMP_FOLDER)
  deal_with_tmp()
  p1 = Process(target=download.main,args=())
  p2 = Process(target=get_vt.main,args=())
  p1.start()
  p2.start()

  #定期中断再执行 
  flag = 0
  while 1:
    time_string = datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    if time_string[11:16] == '11:30' and flag==0:
      flag = 1
      os.system('pkill -f wget')
      if p1.is_alive():
        p1.terminate()
      if p2.is_alive():
        p2.terminate()
      os.system('rm -f '+SPLIT_TASK_FILE)
      count_download = deal_with_tmp()
      # Send Email
      with open(VT_FILE, 'rb') as h:
	count_vt = h.read().split('\n')
      string = '------Daily Mail------' + '\nvt_count:' +  count_vt[0] + '\ndownload: ' + str(count_download)
      #Send the number of extraction.
      #      with open(EXTRACTION_FILE,'rb') as h:
      #	count_extraction = h.read().split('\n')
      #      string = string + '\nextracted:'+str(count_extraction)
      send_email(string)
    if time_string[11:16] == '11:35' and flag==1:
      flag = 0
      p1 = Process(target=download.main,args=())
      p2 = Process(target=get_vt.main,args=())
      p1.start()
      p2.start()
