import os 
from multiprocessing import Pool,Lock

benign_path = '/data/benign/'
malware_path = '/data/malware/'

def get_time(sha256):
  l = os.popen('grep -i '+sha256+' /data/new_latest.csv').read().split(',')
  if len(l) > 3:
    return l[3] 
  else:
    return os.popen('grep -i '+sha256+' /data/android_all_dex.csv').read()[2][:-2]
  
def get_time_csv(files,current_dir):
  pd_file = pd.DataFrame(files,columns=['sha256']) 
  pd_file['time'] = pd_file['sha256'].apply(get_time)
  pd_file.to_csv(current_dir+'time.csv')

if __name__ == '__main__':
#  lock = Lock()
  pool = Pool(16)
  for i in range(16):
    for j in range(16):
      for k in range(16):
	for z in [malware_path,benign_path]:	
	  current_dir = z +'/'.join([hex(i),hex(j),hex(k)])+'/'
          print('deal with ',current_dir)
          files = os.listdir(current_dir)
          files = filter(lambda x:len(x)==64,files)
 	  pool.apply_async(func=get_time_csv,args=(files,current_dir))
	
  pool.close()
  pool.join()
