#!/usr/bin/env python
# -*- coding: utf-8 -*-

#Nankai University Information Security
#QiuKF 1055419050@qq.com
#get file results at fixed time
#create processed.csv at sub dirctories
#create Total_File_Data.csv at /collection

from multiprocessing import Process,Pool
import os
import pandas as pd
import time
import sys
sys.path.append('../core/')
from  setting import SAMPLES_PATH
#samples_path='/data/malware/'
def merge_file():
  
  data = {"sha256":[],"type":[]}
  total_df=pd.DataFrame(data)
  chr=['0','1','2','3','4','5','6','7','8','9','a','b','c','d','e','f']
  for first in chr:
    sub_dir_list=make_file_dir(first)
    for each in sub_dir_list:
      sub_pd=pd.read_csv(SAMPLES_PATH+each+'processed.csv')
      total=[total_df,sub_pd]
      total_df=pd.concat(total)
      print 'concat '+each+'processed.csv'
  total_df.to_csv('Total_File_Data.csv',index=False)

def exe_file(first_dir):
  count=0
  #print 'test'
  
  print 'Run task %s (%s)...' % (first_dir, os.getpid())
  child_dir=make_file_dir(first_dir)
  #print child_dir
  for each_dir in child_dir:
    data = {"sha256":[],"type":[]}
    processed_df=pd.DataFrame(data)
    all_files=os.listdir(SAMPLES_PATH+each_dir)
    for each_file in all_files:
      file_command = os.popen('file ' +SAMPLES_PATH+each_dir+each_file)  
      #print  'file ' +SAMPLES_PATH+each_dir+each_file
      read_data= file_command.read() 
      tmp=read_data[read_data.index(':') + 2 : read_data.index('\n')]
      #print tmp
      processed_df.loc[len(processed_df)]=[each_file,tmp]
    processed_df.to_csv(SAMPLES_PATH+each_dir+'processed.csv',index=False)
    print 'created '+SAMPLES_PATH+each_dir+'processed.csv'
def make_file_dir(first):
  ret=[]
  chr_list=['0','1','2','3','4','5','6','7','8','9','a','b','c','d','e','f']
  tmp=''
  for second in chr_list:
    two='/'+second
    for third in chr_list:
      three=two+'/'+third+'/'
      ret.append(first+three)
    #print len(ret)
    #print ret
  return ret
  

def main():
  #print SAMPLES_PATH
  print('Parent process %s.' %os.getpid())
  #dic_list=make_file_dir()
  first_dic=['0','1','2','3','4','5','6','7','8','9','a','b','c','d','e','f']
  p=Pool(16)
  for each in first_dic:
    #print each
    p.apply_async(exe_file,args=(each,))
  p.close()
  p.join()
  print 'start merging file results...'
  merge_file()
  #is_apk('1.apk')
  #is_apk(base_path+'three')
if __name__=='__main__':
  while True:
    main()
    time.sleep(36000)

                                           
