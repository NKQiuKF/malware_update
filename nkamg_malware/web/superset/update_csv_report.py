#-*- coding: utf-8 -*-

import json
import pandas as pd
import os
import sys
import requests

reload(sys)
sys.setdefaultencoding('utf-8') 
 
PATH_HD = '/data/malware'
URL = 'https://www.virustotal.com/vtapi/v2/file/report'
APIKEY = 'f4770b16db5757516ebc7e46077e50c8eb55bd3d479b74eb499305f1bf38d0ff'

def update_vt_report(sha256,filename,file_type,file_size):
  params = {'apikey': APIKEY, 'resource': sha256}
  response = requests.get(URL, params=params)
  if response.status_code == 200:
    dict_res = response.json()
  else:
    return 2
  time_stamp = os.popen('grep -i '+sha256+' /data/latest.csv').read().split(',')
  reports = pd.read_csv("{0}/{1}/{2}/{3}/{4}".format(PATH_HD,sha256[0],sha256[1],sha256[2],'reports.csv'))
  if len(reports[reports['sha256']==sha256].index)==0:
    reports = reports.append({'sha256':sha256},ignore_index=True)
  if len(time_stamp)>3:
    reports['time_stamp'].loc[reports[reports['sha256']==sha256].index[0]]=time_stamp[3]
  reports['file_name'].loc[reports[reports['sha256']==sha256].index[0]]=filename

  reports['type_y'].loc[reports[reports['sha256']==sha256].index[0]]=file_type
  reports['file_size'].loc[reports[reports['sha256']==sha256].index[0]]=file_size
  reports.to_csv("{0}/{1}/{2}/{3}/{4}".format(PATH_HD,sha256[0],sha256[1],sha256[2],'reports.csv'),sep=',',index=False)
    #vt_information:
  try:
    reports['sha1'].loc[reports[reports['sha256']==sha256].index[0]]=dict_res['sha1'] 
    reports['md5'].loc[reports[reports['sha256']==sha256].index[0]]=dict_res['md5'] 
    reports['scan_date'].loc[reports[reports['sha256']==sha256].index[0]]=dict_res['scan_date']
    reports['positives'].loc[reports[reports['sha256']==sha256].index[0]]=dict_res['positives']
    flag = 0
    for j in dict_res['scans'].keys():
      if dict_res['scans'][j]['result'] != None:
        flag = 1
        reports[j].loc[reports[reports['sha256']==sha256].index[0]] = dict_res['scans'][j]['result']
    reports.to_csv("{0}/{1}/{2}/{3}/{4}".format(PATH_HD,sha256[0],sha256[1],sha256[2],'reports.csv'),sep=',',index=False)
    print str(os.getpid()) +  '->' + dict_csv['sha256'][0] + ' succeed ' 
    return flag
  except Exception,e:
    print "No this record in virustotal"
    return 2
